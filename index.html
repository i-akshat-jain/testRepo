<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Plots</title>
    <!-- Include Plotly library -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Include d3 library -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <div id="loading">Loading...</div>
    <div id="plots-container" style="display: flex; flex-direction: row; flex-wrap: wrap;">
        <label for="mz-selector">Select mz value:</label>
        <select id="mz-selector" onchange="updatePlots()"></select>
        <h1 id="mz-heading"></h1>
    </div>
    <script>
        // Declare fileNames and dataFrames at a higher scope
        var fileNames;
        var dataFrames = {};

        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('plots-container').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('plots-container').style.display = 'flex';
        }

        async function fetchFileNames(folderPath) {
            showLoading();
            try {
                const response = await fetch(folderPath);

                if (!response.ok) {
                    console.log(response.status);
                    throw new Error(`Failed to fetch. Status: ${response.status}`);
                }

                let fileNames;

                try {
                    const clonedResponse = response.clone();
                    fileNames = await clonedResponse.json();
                    console.log("File Names:", fileNames);
                } catch (jsonError) {
                    const textResponse = await response.text();
                    console.log(textResponse);

                    if (textResponse.includes('<ul>')) {
                        const parser = new DOMParser();
                        const htmlDoc = parser.parseFromString(textResponse, 'text/html');
                        const links = htmlDoc.querySelectorAll('a');

                        fileNames = Array.from(links).map(link => link.textContent.trim());
                        for (fileName of fileNames) {
                            if (fileName.endsWith('.csv')) {
                                fileName = fileName.replace('CRC_HILIC_', '').replace('_Ttest.csv', '');
                            }
                        }
                        console.log("File Names:", fileNames);
                    } else {
                        throw new Error('Unexpected response format');
                    }
                }

                return fileNames;
            } catch (error) {
                console.error(`Error fetching file names: ${error.message}`);
                throw error;
            } finally {
                hideLoading();
            }
        }

        function updateMzDropdown() {
            const mzSelector = document.getElementById('mz-selector');
            mzSelector = 694.3166;
            mzSelector.innerHTML = '';

            fileNames.forEach((fileName, index) => {
                if (fileName.endsWith('.csv')) {
                    const mzValue = fileName.replace('CRC_HILIC_', '').replace('_Ttest.csv', '');
                    const option = document.createElement('option');
                    option.value = index;
                    option.text = `m/z = ${parseFloat(mzValue).toFixed(4)}`;
                    mzSelector.appendChild(option);
                }
            });
        }

        function updatePlots() {
            const selectedMzIndex = document.getElementById('mz-selector').value;
            const selectedMzValue = parseFloat(fileNames[selectedMzIndex].replace('CRC_HILIC_', '').replace('_Ttest.csv', ''));

            document.getElementById('mz-heading').innerText = `m/z = ${selectedMzValue.toFixed(4)}`;

            processResults(dataFrames, selectedMzValue);
        }

        async function processData() {
            showLoading();
            try {
                const folderPath = 'NormalvsTumor_HILIC_ALL/';
                fileNames = await fetchFileNames(folderPath);

                await Promise.all(fileNames.map(async (fileName) => {
                    if (fileName.endsWith('.csv')) {
                        const variableName = fileName.replace('CRC_HILIC_', '').replace('_Ttest.csv', '');
                        const filePath = `${folderPath}${fileName}`;

                        try {
                            const response = await fetch(filePath);
                            const data = await response.text();
                            dataFrames[variableName] = await d3.csvParse(data);
                        } catch (error) {
                            console.error(`Error reading file '${fileName}': ${error.message}`);
                        }
                    }
                }));

                updateMzDropdown();
                processResults(dataFrames, parseFloat(fileNames[0].replace('CRC_HILIC_', '').replace('_Ttest.csv', '')));
            } catch (error) {
                console.error(error.message);
            } finally {
                hideLoading();
            }
        }

        function createPlotDiv(variableName) {
            const plotDiv = document.createElement('div');
            plotDiv.id = `plot-${variableName}`;
            plotDiv.style.width = '300px';
            plotDiv.style.height = '500px';
            document.getElementById('plots-container').appendChild(plotDiv);
            return plotDiv.id;
        }

        var resultsDict = {};

        function processResults(dataFrames, selectedMzValue) {
            let plotDivId;

            document.getElementById('mz-heading').innerText = `m/z = ${selectedMzValue.toFixed(4)}`;

            for (const [variableName, df] of Object.entries(dataFrames)) {
                if (variableName.includes('output')) {
                    const selectedRowOutput = df.filter(row => row.mz == selectedMzValue);

                    if (selectedRowOutput.length > 0) {
                        const rawPval = selectedRowOutput[0].raw_pval;
                        const qFdr = selectedRowOutput[0].q_fdr;
                        const logFcMatched = parseFloat(selectedRowOutput[0].log_fc_matched);

                        let qFdrStars = '';
                        if (qFdr < 0.05 && qFdr > 0.01) {
                            qFdrStars = '*';
                        } else if (qFdr < 0.01 && qFdr > 0.001) {
                            qFdrStars = '**';
                        } else if (qFdr < 0.001) {
                            qFdrStars = '***';
                        }

                        console.log(`Results for ${variableName}:`);
                        console.log(`Raw P-value: ${rawPval}`);
                        console.log(`Q FDR: ${qFdr}`);
                        console.log(`Log FC Matched: ${logFcMatched}`);
                        console.log(`Q FDR Stars: ${qFdrStars}`);

                        resultsDict[variableName] = {
                            "rawPval": rawPval,
                            "qFdr": qFdr,
                            "logFcMatched": logFcMatched,
                            "qFdrStars": qFdrStars
                        };
                        console.log('ResultDict for', variableName, resultsDict);
                    } else {
                        console.log(`No data found for the selected 'mz' value in ${variableName}.`);
                    }
                }
            }

            for (var variableName in dataFrames) {
                if (!variableName.includes('output')) {
                    plotDivId = createPlotDiv(variableName);

                    var plotContainer = document.getElementById(plotDivId);
                    var categories = Object.keys(dataFrames);
                    var validCategories = categories.filter(category => !category.includes('output'));

                    var desiredRowIndex = dataFrames[variableName].findIndex(row => row.mz == selectedMzValue);

                    if (desiredRowIndex !== -1) {
                        var rowData = dataFrames[variableName][desiredRowIndex];
                        var caseColumns = Object.keys(rowData).filter(key => key.includes('_Case')).map(key => rowData[key]);
                        var controlColumns = Object.keys(rowData).filter(key => key.includes('_Control')).map(key => rowData[key]);

                        var traceBox1 = {
                            x: Array(caseColumns.length).fill('Tumor'),
                            y: caseColumns,
                            type: 'box',
                            boxpoints: 'all',
                            marker: {
                                color: 'red'
                            },
                            jitter: 0.3,
                            pointpos: -1.8,
                            showlegend: false,
                            name: "Tumor"
                        };

                        var traceBox2 = {
                            x: Array(controlColumns.length).fill('Normal'),
                            y: controlColumns,
                            type: 'box',
                            boxpoints: 'all',
                            marker: {
                                color: 'green'
                            },
                            jitter: 0.3,
                            pointpos: -1.8,
                            showlegend: false,
                            name: "Normal"
                        };

                        var layout = {
                            width: 300,
                            height: 500,
                            xaxis: {
                                title: {
                                    text: '<b>' + variableName + '</b>',
                                    font: {
                                        size: 14,
                                        family: 'Arial, sans-serif',
                                        color: 'black'
                                    }
                                },
                                tickangle: 90,
                            },
                            yaxis: {
                                title: 'Relative Abundance'
                            }
                        };

                        var data = [traceBox1, traceBox2];
                        var tempVariableName = variableName + '_Ttest_output.csv';
                        console.log('Data:', data);
                        console.log('Result Dict:', resultsDict);
                        console.log('Current Variable Name:', tempVariableName);
                        console.log('qFdrStars:', resultsDict[tempVariableName].qFdrStars);
                        console.log('logFcMatched:', resultsDict[tempVariableName].logFcMatched.toFixed(2));
                        console.log('q:' + resultsDict[tempVariableName].qFdrStars + '\nLogFC:' + resultsDict[tempVariableName].logFcMatched.toFixed(2));

                        var annotations = [
                            {
                                x: 1.01,
                                y: 0.94,
                                text: 'q:' + resultsDict[tempVariableName].qFdrStars + '\n\nLogFC:' + resultsDict[tempVariableName].logFcMatched.toFixed(2),
                                xref: 'paper',
                                yref: 'paper',
                                showarrow: false,
                                font: {
                                    size: 12,
                                    color: 'black'
                                }
                            }
                        ];

                        layout.annotations = annotations;

                        Plotly.newPlot(plotContainer, data, layout);
                        console.log("Plot done for DataFrame '" + variableName + "'");
                    } else {
                        console.log("No unique row found for the selected 'mz' value in DataFrame '" + variableName + "'.");
                    }
                }
            }
        }

        // Load and process data on page load
        processData();
    </script>
</body>
</html>
